<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>ParM: hardspheres.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParM
   &#160;<span id="projectnumber">parm</span>
   </div>
   <div id="projectbrief">A molecular dynamics library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">hardspheres.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Collision-Driven Brownian-Dynamics</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;set&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cstdlib&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="vecrand_8hpp.html">vecrand.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="interaction_8hpp.html">interaction.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="collection_8hpp.html">collection.hpp</a>&quot;</span></div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacestd.html">std</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Some constants</span></div>
<div class="line"><span class="comment">// Note that &quot;flt&quot; is a &quot;floating point number&quot;, defaults to &quot;double&quot;</span></div>
<div class="line"><span class="comment">// but can be compiled as &quot;long double&quot; if needed</span></div>
<div class="line"><span class="comment">//const flt phi = 0.27;</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> sigma = 1.0;</div>
<div class="line"><span class="comment">//const flt dt0 = 0.0001;</span></div>
<div class="line"><span class="comment">//const flt dt1 = 1.0;</span></div>
<div class="line"><span class="comment">// uint is just short for unsigned int</span></div>
<div class="line"><span class="comment">//const uint Natoms = 24;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// for the &quot;relaxing&quot; stage</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> epsilon = 1.0;</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> sigcut = 1.0;</div>
<div class="line"></div>
<div class="line"><span class="comment">// for the hard-sphere run</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> T = 1.0;</div>
<div class="line"><span class="comment">//const flt dt = 0.02; // time between velocity reshuffling</span></div>
<div class="line"><span class="comment">//const flt tottime = 200000; // total number of steps to run</span></div>
<div class="line"><span class="comment">//const flt sizeratio = 2.0;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Data parameters</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> nMSDs = 400; <span class="comment">// this is the goal; duplicates removed, so it will be less</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Other parameters</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> printn = 100;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Function for writing a frame to an open file (see below)</span></div>
<div class="line"><span class="keywordtype">void</span> writefile(ofstream&amp; outf, <a name="_a0"></a><a class="code" href="class_atom_vec.html">AtomVec</a>&amp; atoms, <a name="_a1"></a><a class="code" href="class_box.html">Box</a>&amp; bx);</div>
<div class="line"><span class="comment">// Function for writing box size / atomsize to file (see below)</span></div>
<div class="line"><span class="keywordtype">void</span> writetcl(<span class="keyword">const</span> <span class="keywordtype">char</span> *fname, <a name="_a2"></a><a class="code" href="class_origin_box.html">OriginBox</a>&amp; box, vector&lt;flt&gt; &amp;atomsizes);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv){</div>
<div class="line">    <span class="keywordtype">int</span> c;</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> phi=.40;</div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> sizeratio=2.0;</div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> dt=0.02;</div>
<div class="line">    <span class="keywordtype">int</span> Natoms=40;</div>
<div class="line">    <span class="keywordtype">int</span> tottime=2000000;</div>
<div class="line">    <span class="keywordtype">string</span> outname = <span class="stringliteral">&quot;hardspheres.msd&quot;</span>;</div>
<div class="line"></div>
<div class="line">    opterr = 0;</div>
<div class="line">    <span class="keywordflow">while</span> ((c = getopt (argc, argv, <span class="stringliteral">&quot;n:f:s:d:t:o:&quot;</span>)) != -1) <span class="keywordflow">switch</span> (c){</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>: <span class="comment">//Number of particles</span></div>
<div class="line">            Natoms = (int) atol(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>: <span class="comment">//Phi -Packing fraction</span></div>
<div class="line">            phi = atof(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>: <span class="comment">//Size ratio of large particle to small particle</span></div>
<div class="line">            sizeratio = atof(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>: <span class="comment">//dt of integration of simulation</span></div>
<div class="line">            dt = (<a name="a3"></a><a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a>) atof(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>: <span class="comment">// total time of simulation</span></div>
<div class="line">            tottime = (int) atof(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:</div>
<div class="line">            outname = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            abort ();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="comment">//~ srand ( time(NULL) );</span></div>
<div class="line">    <span class="comment">//~ srand(10000);</span></div>
<div class="line">    ofstream myfile;</div>
<div class="line">    myfile.open(outname.c_str());</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Running...&quot;</span> &lt;&lt; endl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">string</span> xyzname=outname.substr(0,outname.size()-4)+<span class="stringliteral">&quot;.xyz&quot;</span>;</div>
<div class="line">    <span class="keywordtype">string</span> tclname=outname.substr(0,outname.size()-4)+<span class="stringliteral">&quot;.tcl&quot;</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// new random seed each time, for velocities and placement</span></div>
<div class="line">    <a name="a4"></a><a class="code" href="vecrand_8cpp.html#aec71d81c835e6d590db0e0ab34c8e2f5">seed</a>();</div>
<div class="line">    </div>
<div class="line">    vector&lt;flt&gt; atomsizes(Natoms, sigma);</div>
<div class="line">    atomsizes[0] = sigma * sizeratio;</div>
<div class="line">    vector&lt;flt&gt; atommasses(Natoms, 1);</div>
<div class="line">    atommasses[0] = pow(sizeratio, <a name="a5"></a><a class="code" href="vecrand_8hpp.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>); <span class="comment">// NDIM is &quot;number of dimensions&quot; (i.e., 3)</span></div>
<div class="line">    </div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> Vs = 0;</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i=0; i&lt;atomsizes.size(); ++i){</div>
<div class="line">        Vs += pow(atomsizes[i], <a class="code" href="vecrand_8hpp.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>) * M_PI / 2 / <a class="code" href="vecrand_8hpp.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>;</div>
<div class="line">    };</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> L = pow(Vs/phi, <a name="a6"></a><a class="code" href="vecrand_8hpp.html#aa4c4eddddfed65be9edd9a5d04d9b93e">OVERNDIM</a>); <span class="comment">// OVERNDIM is &quot;1/number of dimensions&quot; (i.e., 1.0/3.0)</span></div>
<div class="line">    assert(L &gt; (atomsizes[0] + atomsizes[1]));</div>
<div class="line">    <span class="comment">// if the box is not wider than two atoms, this algorithm will have trouble</span></div>
<div class="line">    </div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;phi &quot;</span> &lt;&lt; (Vs/pow(L,<a class="code" href="vecrand_8hpp.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>)) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Create the bounding box (sides of length L), and a &quot;vector&quot; of Natoms atoms</span></div>
<div class="line">    boost::shared_ptr&lt;OriginBox&gt; obox(<span class="keyword">new</span> <a class="code" href="class_origin_box.html">OriginBox</a>(L));</div>
<div class="line">    boost::shared_ptr&lt;Box&gt; boxptr = boost::static_pointer_cast&lt;<a class="code" href="class_box.html">Box</a>&gt;(obox);</div>
<div class="line">    boost::shared_ptr&lt;AtomVec&gt; atomptr(<span class="keyword">new</span> <a class="code" href="class_atom_vec.html">AtomVec</a>(atommasses));</div>
<div class="line">    boost::shared_ptr&lt;AtomGroup&gt; group(atomptr);</div>
<div class="line">    <a class="code" href="class_atom_vec.html">AtomVec</a> &amp; atoms = *atomptr;</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="comment">// The relaxing stage</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Repulsion Interaction, for the relaxing stage</span></div>
<div class="line">    <span class="comment">//(new NeighborList(obox, sigcut*sigma, 1.4*(sigcut*sigma)));</span></div>
<div class="line">    boost::shared_ptr&lt;NListed&lt;EpsSigExpAtom, RepulsionPair&gt; &gt; hertz(</div>
<div class="line">        <span class="keyword">new</span> <a name="_a7"></a><a class="code" href="class_n_listed.html">NListed&lt;EpsSigExpAtom, RepulsionPair&gt;</a>(</div>
<div class="line">            boxptr, atomptr, 0.4*(sigcut*sigma)</div>
<div class="line">    ));</div>
<div class="line">    boost::shared_ptr&lt;NeighborList&gt; nl = hertz-&gt;neighbor_list();</div>
<div class="line">    <span class="comment">// ^ this is the Interaction</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// A Repulsion Interaction has energy </span></div>
<div class="line">    <span class="comment">//    Uij = {1/2.5 * |sigma_ij - r_ij|^2.5      r_ij &lt; sigma_ij</span></div>
<div class="line">    <span class="comment">//           0                                  r_ij &gt;= sigma_ij</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Note that NListed is a class template; its an Interaction that</span></div>
<div class="line">    <span class="comment">// takes various structs as template parameters, and turns them into </span></div>
<div class="line">    <span class="comment">// a neighbor Interaction</span></div>
<div class="line">    <span class="comment">// See interaction.hpp for a whole bunch of them</span></div>
<div class="line">    <span class="comment">// Also note that the NeighborList is not the same as the</span></div>
<div class="line">    <span class="comment">// &quot;neighborlisted&quot; Interaction; multiple interactions can use the</span></div>
<div class="line">    <span class="comment">// same NeighborList</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Now we run through all the atoms, set their positions / velocities,</span></div>
<div class="line">    <span class="comment">// and add them to the hertzian Interaction (i.e., to the neighbor list)</span></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i=0; i &lt; atoms.<a name="a8"></a><a class="code" href="class_atom_vec.html#ab7eb6c6b80bf5c7dad8fbd649c342ce0">size</a>(); i++){</div>
<div class="line">        <span class="comment">// we track energy to see if things are overlapping</span></div>
<div class="line">        atoms[i].x = obox-&gt;rand_loc(); <span class="comment">// random location in the box</span></div>
<div class="line">        atoms[i].v = Vec::Zero();</div>
<div class="line">        atoms[i].f = Vec::Zero();</div>
<div class="line">        atoms[i].a = Vec::Zero();</div>
<div class="line">        </div>
<div class="line">        <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> cursigma = sigma;</div>
<div class="line">        <span class="keywordflow">if</span>(i==0) (cursigma = sigma*sizeratio);</div>
<div class="line">        <span class="comment">// Add it to the potential</span></div>
<div class="line">        hertz-&gt;add(<a name="_a9"></a><a class="code" href="struct_eps_sig_exp_atom.html">EpsSigExpAtom</a>(atoms.<a name="a10"></a><a class="code" href="class_atom_vec.html#acfb688c87a0616c6d76b9faf7e052d4e">get_id</a>(i), epsilon, cursigma, sigcut));</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// force an update the NeighborList, just to make sure</span></div>
<div class="line">    nl-&gt;update_list(<span class="keyword">true</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">//Now we make our &quot;Collection&quot;</span></div>
<div class="line">    <a name="_a11"></a><a class="code" href="class_collection_overdamped.html">CollectionOverdamped</a> collec0 = <a class="code" href="class_collection_overdamped.html">CollectionOverdamped</a>(boxptr, atomptr, 1e-3);</div>
<div class="line">    <span class="comment">// CollectionOverdamped uses &quot;overdamped&quot; dynamics, meaning that </span></div>
<div class="line">    <span class="comment">// dx/dt = γ f</span></div>
<div class="line">    <span class="comment">// here we use γ = 1, because it doesn&#39;t matter</span></div>
<div class="line">    <span class="comment">// Note that this Collection always goes down the potential energy gradient</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// This is very important! Otherwise the NeighborList won&#39;t update!</span></div>
<div class="line">    collec0.<a name="a12"></a><a class="code" href="class_collection.html#a27d3572b81a8e747fd1b37c736c13648">add_tracker</a>(nl);</div>
<div class="line">    <span class="comment">// And add the Interaction</span></div>
<div class="line">    collec0.<a name="a13"></a><a class="code" href="class_collection.html#a8327c4cdb81bcd50d43662b8c7e6e714">add_interaction</a>(hertz);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// subtract off center of mass velocity, and set a total energy</span></div>
<div class="line">    collec0.<a name="a14"></a><a class="code" href="class_collection.html#a6a1785b2884b5f4834a8e685f4aa49b1">reset_com_velocity</a>();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Potential energy per Atom</span></div>
<div class="line">    <span class="keywordtype">int</span> swtch = 0; <span class="comment">//Switch to help terminate simulations of unattainable packing fractions</span></div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> U = collec0.<a name="a15"></a><a class="code" href="class_collection.html#af8fa6055c3783d8accc9667c057da38f">potential_energy</a>()/Natoms;</div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> U1 = U; <span class="comment">//U at prior timestep</span></div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> U0 = U; <span class="comment">//Initial potential energy</span></div>
<div class="line">    cout    &lt;&lt; <span class="stringliteral">&quot;Energy0:  &quot;</span> &lt;&lt; U &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    <span class="comment">// note that U is &gt; 0 if any atoms overlap, and U = 0 when no atoms overlap</span></div>
<div class="line">    <span class="comment">// so we run</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span>(swtch == 0){</div>
<div class="line">    <span class="keywordflow">if</span> (U==0){</div>
<div class="line">        swtch=1;</div>
<div class="line">        }   </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (U&lt;=U0){</div>
<div class="line">        <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i=0; i&lt;1000; ++i) collec0.<a name="a16"></a><a class="code" href="class_collection_overdamped.html#a2d08abce24e5a2397ac49a3ae3b762da">timestep</a>();</div>
<div class="line">        U1=U;</div>
<div class="line">        U = collec0.<a class="code" href="class_collection.html#af8fa6055c3783d8accc9667c057da38f">potential_energy</a>()/Natoms;</div>
<div class="line">        cout    &lt;&lt; <span class="stringliteral">&quot;Energy:  &quot;</span> &lt;&lt; U &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (U&gt;.99*U1){</div>
<div class="line">        swtch=1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    cout    &lt;&lt; <span class="stringliteral">&quot;Energyf:  &quot;</span> &lt;&lt; U &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (U==0){</div>
<div class="line">    <span class="comment">// The equilibration stage</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// This is the Brownian motion, hard-sphere collider</span></div>
<div class="line">    <a name="_a17"></a><a class="code" href="class_collection_c_d_b_dgrid.html">CollectionCDBDgrid</a> collec = <a class="code" href="class_collection_c_d_b_dgrid.html">CollectionCDBDgrid</a>(obox, atomptr, dt, T, atomsizes);</div>
<div class="line">    </div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Equilibrating... \n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i=0; i&lt;printn; ++i){</div>
<div class="line">        <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> j=0; j&lt;(tottime/printn); ++j) collec.<a name="a18"></a><a class="code" href="class_collection_c_d_b_dgrid.html#a84eaa9155c5c7ad53f4b7e526f71bf54">timestep</a>();</div>
<div class="line">        cout &lt;&lt; (printn-i) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; std::flush;</div>
<div class="line">    }</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Done.\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// The data stage</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Now we need to make the RsqTracker (which tracks r squared vs. time)</span></div>
<div class="line">    <span class="comment">// we need to tell it which Δts to track, so we do that here.</span></div>
<div class="line">    <span class="comment">// Note that a set is a Collection that is sorted and removes duplicates,</span></div>
<div class="line">    <span class="comment">// so that&#39;s why we start with a set.</span></div>
<div class="line">    <span class="comment">// So </span></div>
<div class="line">    set&lt;uint&gt; nset;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Log-spaced Δts</span></div>
<div class="line">    <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> maxlog = log(tottime);</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> n=0; n&lt;nMSDs; n++){</div>
<div class="line">        <a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a> newlog = (maxlog * n) / (nMSDs-1);</div>
<div class="line">        <a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> newn = (<a name="a19"></a><a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>) ceil(exp(newlog));</div>
<div class="line">        <span class="keywordflow">if</span>(newn &lt;= 0) newn = 1;</div>
<div class="line">        <span class="keywordflow">if</span>(newn &gt; (<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>)tottime) newn = tottime;</div>
<div class="line">        nset.insert(newn);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    vector&lt;long unsigned int&gt; MSDns(nset.begin(), nset.end());</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Using &quot;</span> &lt;&lt; MSDns.size() &lt;&lt; <span class="stringliteral">&quot; MSDns, [&quot;</span> &lt;&lt; MSDns.front() &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; MSDns.back() &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">    boost::shared_ptr&lt;RsqTracker&gt; rsqtracker(<span class="keyword">new</span> <a name="_a20"></a><a class="code" href="class_rsq_tracker.html">RsqTracker</a>(atomptr, MSDns));</div>
<div class="line">    boost::shared_ptr&lt;StateTracker&gt; rsqptr = boost::static_pointer_cast&lt;<a name="_a21"></a><a class="code" href="class_state_tracker.html">StateTracker</a>&gt;(rsqtracker);</div>
<div class="line">    collec.<a name="a22"></a><a class="code" href="class_collection.html#a32f2f42a8c7bf71845b88691f2cd8c8d">add</a>(rsqptr);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// VMD is good for 3D visualization purposes, and it can read .xyz files</span></div>
<div class="line">    <span class="comment">// see &#39;writefile&#39; function</span></div>
<div class="line">    ofstream xyzfile;</div>
<div class="line">    xyzfile.open(xyzname.c_str(), ios::out);</div>
<div class="line">    writefile(xyzfile, atoms, *obox);</div>
<div class="line">    writetcl(tclname.c_str(), *obox, atomsizes); <span class="comment">// see below</span></div>
<div class="line">                                                       <span class="comment">// unnecessary extra</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Now we really start running</span></div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Running... \n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i=0; i&lt;printn; ++i){</div>
<div class="line">        <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> j=0; j&lt;(tottime/printn); ++j) collec.<a class="code" href="class_collection_c_d_b_dgrid.html#a84eaa9155c5c7ad53f4b7e526f71bf54">timestep</a>();</div>
<div class="line">        </div>
<div class="line">        cout &lt;&lt; (printn-i) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; std::flush;</div>
<div class="line">        writefile(xyzfile, atoms, *obox);</div>
<div class="line">    }</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Done, saving MSDs\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Save the MSDs to a file</span></div>
<div class="line">    ofstream msdfile;</div>
<div class="line">    msdfile.open(outname.c_str(), ios::out);</div>
<div class="line">    <span class="comment">// Retrieve the time-averaged r^2 values for each Atom for each Δt</span></div>
<div class="line">    vector&lt;Eigen::Matrix&lt;flt, Eigen::Dynamic, NDIM&gt; &gt; MSDmeans = rsqtracker-&gt;xyz2();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// This will be a tab-separated file, with the first column being </span></div>
<div class="line">    <span class="comment">// Δt in time units (not timesteps),</span></div>
<div class="line">    <span class="comment">// second column &lt;r(t) - r(t-Δt)&gt;² for the large particle </span></div>
<div class="line">    <span class="comment">// in units of the small particle diameters,</span></div>
<div class="line">    <span class="comment">// third column &lt;r(t) - r(t-Δt)&gt;² for the first small particle,</span></div>
<div class="line">    <span class="comment">// 4th column &lt;r(t) - r(t-Δt)&gt;² for the second small particle, etc.</span></div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i=0; i&lt;MSDns.size(); i++){</div>
<div class="line">        msdfile &lt;&lt; (((<a class="code" href="vecrand_8hpp.html#aba18dc05b48d6b6580d8b1b77a876a81">flt</a>) MSDns[i]) * dt);</div>
<div class="line">        <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> j=0; j&lt;MSDmeans[i].rows(); j++){</div>
<div class="line">            <a class="code" href="vecrand_8hpp.html#aa0c2bcbdfaf637fa46ae67b5685ce75c">Vec</a> v = MSDmeans[i].row(j);</div>
<div class="line">            msdfile &lt;&lt; <span class="charliteral">&#39;\t&#39;</span> &lt;&lt; (v[0] + v[1] + v[2]);</div>
<div class="line">        }</div>
<div class="line">        msdfile &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    } </div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Now you should be able to run &quot;vmd -e hardspheres-pbc.tcl hardspheres.xyz&quot;</span></div>
<div class="line">    <span class="comment">// and it will show you the movie and also the bounding box</span></div>
<div class="line">    <span class="comment">// if you have .vmdrc in that same directory, you should also be able</span></div>
<div class="line">    <span class="comment">// to toggle the box with the &quot;b&quot; button</span></div>
<div class="line"></div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;Done.&quot;</span> &lt;&lt; endl;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> writetcl(<span class="keyword">const</span> <span class="keywordtype">char</span> *fname, <a class="code" href="class_origin_box.html">OriginBox</a>&amp; box, vector&lt;flt&gt; &amp;atomsizes){</div>
<div class="line">    <span class="comment">// Unnecessary extra:</span></div>
<div class="line">    <span class="comment">// Write a &quot;tcl&quot; file with the box boundaries and the Atom sizes</span></div>
<div class="line">    <span class="comment">// the &quot;tcl&quot; file is made specifically for VMD</span></div>
<div class="line">    ofstream pbcfile;</div>
<div class="line">    pbcfile.open(fname, ios::out);</div>
<div class="line">    <span class="comment">// large Atom size</span></div>
<div class="line">    pbcfile &lt;&lt; <span class="stringliteral">&quot;set natoms [atomselect 0 \&quot;name O\&quot;;];\n&quot;</span>;</div>
<div class="line">    pbcfile &lt;&lt; <span class="stringliteral">&quot;$natoms set radius &quot;</span> &lt;&lt; (atomsizes[0]/2.0) &lt;&lt; <span class="stringliteral">&quot;;\n&quot;</span>;</div>
<div class="line">    <span class="comment">// small Atom size</span></div>
<div class="line">    pbcfile &lt;&lt; <span class="stringliteral">&quot;set natoms [atomselect 0 \&quot;name C\&quot;;];\n&quot;</span>;</div>
<div class="line">    pbcfile &lt;&lt; <span class="stringliteral">&quot;$natoms set radius &quot;</span> &lt;&lt; (atomsizes[1]/2.0) &lt;&lt; <span class="stringliteral">&quot;;\n\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">    pbcfile &lt;&lt; <span class="stringliteral">&quot;set cell [pbc set {&quot;</span>;</div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> j=0; j&lt;<a class="code" href="vecrand_8hpp.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>; j++){</div>
<div class="line">        pbcfile &lt;&lt; box.box_shape()[j] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    pbcfile &lt;&lt; <span class="stringliteral">&quot;} -all];\n&quot;</span>;</div>
<div class="line">    pbcfile &lt;&lt; <span class="stringliteral">&quot;pbc box -toggle -center origin -color red;\n&quot;</span>;</div>
<div class="line">    <span class="comment">// Now you should be able to run &quot;vmd -e hardspheres-pbc.tcl hardspheres.xyz&quot;</span></div>
<div class="line">    <span class="comment">// and it will show you the movie and also the bounding box</span></div>
<div class="line">    <span class="comment">// if you have .vmdrc in that same directory, you should also be able</span></div>
<div class="line">    <span class="comment">// to toggle the box with the &quot;b&quot; button</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> writefile(ofstream&amp; outf, <a class="code" href="class_atom_vec.html">AtomVec</a>&amp; atoms, <a class="code" href="class_box.html">Box</a>&amp; bx){</div>
<div class="line">    <span class="comment">// The .xyz format is simple:</span></div>
<div class="line">    <span class="comment">// Line 1: [Number of atoms]</span></div>
<div class="line">    <span class="comment">// Line 2: [Comment line, whatever you want, left blank here]</span></div>
<div class="line">    <span class="comment">// Line 3: [element type, here C for carbon]\t[x]\t[y]\t[z]</span></div>
<div class="line">    <span class="comment">// Line 4: [element type, here C for carbon]\t[x]\t[y]\t[z]</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">    <span class="comment">// Line N+1: [element type, here C for carbon]\t[x]\t[y]\t[z]</span></div>
<div class="line">    <span class="comment">// Line N+2: [element type, here C for carbon]\t[x]\t[y]\t[z]</span></div>
<div class="line">    <span class="comment">// Line N+3: [Number of atoms]</span></div>
<div class="line">    <span class="comment">// Line N+4: [Comment line, whatever you want, left blank here]</span></div>
<div class="line">    <span class="comment">// Line N+5: [element type, here C for carbon]\t[x]\t[y]\t[z]</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">    <span class="comment">// And so on. each set of N atoms/coordinates corresponds to a &quot;frame&quot;, </span></div>
<div class="line">    <span class="comment">// which then make a movie. There must be the same N in each frame for VMD.</span></div>
<div class="line">    <span class="comment">// Note that if this is compiled as a 2D simulation, it will leave out</span></div>
<div class="line">    <span class="comment">// the z coordinate, and VMD can&#39;t handle that.</span></div>
<div class="line">    </div>
<div class="line">    outf &lt;&lt; atoms.<a class="code" href="class_atom_vec.html#ab7eb6c6b80bf5c7dad8fbd649c342ce0">size</a>() &lt;&lt; endl;</div>
<div class="line">    outf &lt;&lt; endl; <span class="comment">// blank line for comment</span></div>
<div class="line">    <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i=0; i&lt;atoms.<a class="code" href="class_atom_vec.html#ab7eb6c6b80bf5c7dad8fbd649c342ce0">size</a>(); i++){</div>
<div class="line">        <span class="keywordflow">if</span>(i == 0){outf &lt;&lt; <span class="stringliteral">&quot;O&quot;</span>;}</div>
<div class="line">        <span class="keywordflow">else</span>{outf &lt;&lt; <span class="stringliteral">&quot;C&quot;</span>;};</div>
<div class="line">        <a class="code" href="vecrand_8hpp.html#aa0c2bcbdfaf637fa46ae67b5685ce75c">Vec</a> normloc = bx.<a name="a23"></a><a class="code" href="class_box.html#af9524b1dbd420bb8b49e9f8e0e21d7f8">diff</a>(Vec::Zero(), atoms[i].x);</div>
<div class="line">        <span class="keywordflow">for</span>(<a class="code" href="vec_8hpp.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> j=0; j&lt;<a class="code" href="vecrand_8hpp.html#a2b1fd2d28c6a7d4a3f7027cc1b6466f3">NDIM</a>; j++){</div>
<div class="line">            outf &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; normloc[j];</div>
<div class="line">        }</div>
<div class="line">        outf &lt;&lt; endl;</div>
<div class="line">    };</div>
<div class="line">};</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Oct 9 2015 15:55:28 for ParM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
